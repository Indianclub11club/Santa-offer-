<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Free Followers Rewards</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #833AB4; --secondary: #FD1D1D; --accent: #FCAF45; --bg: #f4f4f4; --text: #333; --white: #fff; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 70px; margin: 0; }
        .hidden { display: none !important; }
        
        .btn { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn:disabled { background: #888 !important; cursor: not-allowed; opacity: 0.7; transform: none; }
        
        .card { background: var(--white); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* LIVE ORDER CARD CSS */
        .live-order-card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center;
            justify-content: space-between; border: 1px solid #f0f0f0; transition: all 0.5s ease;
            position: relative; overflow: hidden;
        }
        .live-order-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .card-insta::before { background: #833AB4; }
        .card-youtube::before { background: #FF0000; }
        .card-ad::before { background: #333; }

        .order-left { display: flex; align-items: center; gap: 12px; }
        .order-right { text-align: right; }
        .platform-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .icon-insta { background: #f0ebf4; color: #833AB4; }
        .icon-youtube { background: #fff0f0; color: #FF0000; }
        .icon-ad { background: #eee; color: #333; }

        .order-info h4 { margin: 0; font-size: 0.95rem; color: #333; font-weight: 700; }
        .order-info small { color: #27ae60; font-weight: 600; font-size: 0.7rem; display: flex; align-items: center; gap: 4px; margin-top: 2px; }
        .points-badge { background: #fff8e1; color: #f39c12; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 800; border: 1px solid #ffe0b2; margin-bottom: 5px; display: inline-block; }

        .action-btn-small { background: #333; color: white; border: none; padding: 6px 15px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600; width: 100%; transition: 0.2s; }
        .action-btn-small:disabled { background: #eee; color: #999; cursor: not-allowed; border: 1px solid #ddd; }
        .action-btn-small:hover { background: #000; }

        /* BONUS & OTHERS */
        .bonus-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .bonus-card { flex: 1; text-align: center; padding: 15px 5px; color: white; border-radius: 12px; position: relative; }
        .daily-card { background: linear-gradient(135deg, #FFD700, #FFA500); border: 1px solid #e6b800; }
        .lucky-card { background: linear-gradient(135deg, #8E2DE2, #4A00E0); border: 1px solid #7209b7; }
        .bonus-btn { background: white; color: #333; width: auto; padding: 6px 15px; border-radius: 20px; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-top: 8px; border: none; font-weight: bold; cursor: pointer; }
        .timer-text { font-size: 0.65rem; display: block; margin-top: 5px; font-weight: bold; color: rgba(255,255,255,0.9); }

        .header { background: var(--white); padding: 20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .stats-row { display: flex; justify-content: space-between; margin-top: 10px; }
        .stat-box { text-align: center; width: 48%; background: #f9f9f9; padding: 10px; border-radius: 10px; border: 1px solid #eee; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--primary); }

        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .screen { padding: 20px; min-height: 100vh; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--white); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 50; }
        .nav-item { text-align: center; color: #888; font-size: 0.8rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 85%; max-width: 350px; border-radius: 15px; padding: 0; text-align: center; animation: popUp 0.4s ease-out; overflow: hidden; }
        .modal-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 20px; color: white; }
        .modal-body { padding: 20px; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 5px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 80px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        #splash-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; }
        .auth-toggle { margin-top: 15px; font-size: 0.9rem; color: #555; cursor: pointer; text-decoration: underline; }
        
        .progress-track { width: 100%; background: #eee; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }
        .order-status { font-size: 0.8rem; display: flex; justify-content: space-between; margin-top: 5px; color: #666; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: white; }
    </style>
</head>
<body>

    <div id="splash-screen"><h1>ðŸš€ InstaRewards</h1><p>Loading...</p></div>

    <div id="welcome-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fas fa-rocket" style="font-size:3rem; margin-bottom:10px;"></i>
                <h2 style="margin:0;">Grow Fast!</h2>
            </div>
            <div class="modal-body">
                <h3 style="margin:0 0 10px 0;">Welcome Back!</h3>
                <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">Complete tasks, spin the Lucky Bonus, and get real followers instantly.</p>
                <button class="btn" onclick="closeModal()">Start Earning ðŸš€</button>
            </div>
        </div>
    </div>

    <div id="auth-screen" class="screen hidden">
        <div class="card" style="text-align: center; margin-top: 30px;">
            <h2 id="auth-title">Login ðŸ‘‹</h2>
            <input type="text" id="inp-insta" placeholder="Instagram ID (Username)">
            <input type="password" id="inp-password" placeholder="Password">
            <div id="signup-fields" class="hidden">
                <input type="text" id="inp-name" placeholder="Full Name">
                <input type="tel" id="inp-mobile" placeholder="Mobile Number">
            </div>
            <button class="btn" onclick="handleAuth()" id="btn-auth">Login</button>
            <p class="auth-toggle" onclick="toggleAuthMode()">
                <span id="toggle-text">Don't have an account? Create New</span>
            </p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="header">
            <h3 id="user-welcome">Hello</h3>
            <div class="stats-row">
                <div class="stat-box"><div class="stat-val" id="disp-points">0</div><div>Points</div></div>
                <div class="stat-box"><div class="stat-val" id="disp-coins">0</div><div>Coins</div></div>
            </div>
            <button class="btn" style="background: #333; font-size: 0.9rem;" onclick="convertPoints()">ðŸ”„ Convert 10 Pts = 1 Coin</button>
        </div>

        <div id="tab-home" class="screen" style="padding-top: 0;">
            
            <div class="bonus-row">
                <div class="bonus-card daily-card">
                    <h4><i class="fas fa-calendar-check"></i> Daily</h4>
                    <p style="font-size:0.75rem;">+2 Coins</p>
                    <button id="btn-daily-bonus" class="bonus-btn" onclick="claimDailyBonus()">Claim</button>
                    <small id="bonus-timer" class="timer-text"></small>
                </div>
                <div class="bonus-card lucky-card">
                    <h4><i class="fas fa-dice"></i> Lucky</h4>
                    <p style="font-size:0.75rem;">Win 5-50 Pts</p>
                    <button id="btn-lucky-bonus" class="bonus-btn" onclick="claimLuckyBonus()">Spin</button>
                    <small id="lucky-timer" class="timer-text"></small>
                </div>
            </div>

            <h3>ðŸŽ¯ Official Tasks</h3>
            <div class="card">
                <div class="live-order-card card-ad">
                    <div class="order-left">
                        <div class="platform-icon icon-ad"><i class="fas fa-bullhorn"></i></div>
                        <div class="order-info"><h4>Open Ad Link</h4><small>Wait 30s</small></div>
                    </div>
                    <div class="order-right">
                        <div class="points-badge">+25 Pts</div>
                        <button class="action-btn-small" onclick="doAdTask()">Go <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <div class="live-order-card card-insta">
                    <div class="order-left">
                        <div class="platform-icon icon-insta"><i class="fab fa-instagram"></i></div>
                        <div class="order-info"><h4>Official Follow</h4><small>One Time</small></div>
                    </div>
                    <div class="order-right">
                        <div class="points-badge">+25 Pts</div>
                        <button id="btn-official-task" class="action-btn-small" onclick="doStaticInstaTask()">Follow</button>
                    </div>
                </div>
            </div>

            <h3>ðŸ”¥ Live User Orders <span style="background:red; color:white; padding:2px 5px; border-radius:4px; font-size:0.7rem;">LIVE</span></h3>
            <div id="dynamic-tasks-container">
                <p style="text-align:center; color:#999; padding: 10px;">Loading live orders...</p>
            </div>
        </div>

        <div id="tab-order" class="screen hidden" style="padding-top: 0;">
            <div class="card">
                <h3>ðŸ‘¥ Place Order</h3>
                <select id="order-platform" onchange="updateOrderPlaceholder()">
                    <option value="insta">ðŸ“¸ Instagram Followers</option>
                    <option value="youtube">â–¶ YouTube Subscribers</option>
                </select>
                <input type="text" id="order-link" placeholder="Paste Instagram Profile Link...">
                
                <select id="order-select">
                    <option value="10|5">10 Coins = 5 Followers/Subs</option>
                    <option value="20|10">20 Coins = 10 Followers/Subs</option>
                    <option value="50|25">50 Coins = 25 Followers/Subs</option>
                    <option value="100|50">100 Coins = 50 Followers/Subs</option>
                    <option value="200|100">200 Coins = 100 Followers/Subs</option>
                    <option value="500|250">500 Coins = 250 Followers/Subs</option>
                </select>

                <button class="btn" onclick="placeOrder()">Order Now</button>
            </div>
            <div style="margin-top:20px;">
                <h3>ðŸ“œ Order History</h3>
                <div id="my-orders-container"><p style="text-align:center; color:#999;">Loading...</p></div>
            </div>
        </div>

        <div id="tab-invite" class="screen hidden" style="padding-top: 0;">
            <div class="card" style="text-align: center;">
                <h3>Invite Friends</h3>
                <p style="font-weight:bold; color:var(--primary); font-size:1.1rem;">Get 30 Coins per Invite!</p>
                <p style="font-size:0.8rem; color:#666;">Share your link and earn big!</p>
                <input type="text" id="referral-link" readonly>
                <button class="btn" onclick="copyInvite()">Copy Link</button>
                <button class="btn" style="background:#e74c3c; margin-top:10px;" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <div id="bottom-nav" class="bottom-nav hidden">
        <div class="nav-item active" onclick="switchTab('home')"><i class="fas fa-home"></i> Tasks</div>
        <div class="nav-item" onclick="switchTab('order')"><i class="fas fa-shopping-cart"></i> Order</div>
        <div class="nav-item" onclick="switchTab('invite')"><i class="fas fa-users"></i> Invite</div>
    </div>
    
    <div id="toast">Message</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, child, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC2QinoK69jefCd6jV2BxrNYX0LdangRbY",
            authDomain: "cashtaskerpro.firebaseapp.com",
            databaseURL: "https://cashtaskerpro-default-rtdb.firebaseio.com",
            projectId: "cashtaskerpro",
            storageBucket: "cashtaskerpro.firebasestorage.app",
            messagingSenderId: "214798083032",
            appId: "1:214798083032:web:a55242444183ebaca888ad"
        };
        const TG_BOT_TOKEN = "8341819746:AAEXZqtOjP_Z8cpPIY7teYNzASfSBpR58QA";
        const TG_CHAT_ID = "5627610200";
        
        let smartAdLinks = ["https://google.com"];
        let fixedInstaLink = "https://instagram.com";
        const luckySmartLink = "https://www.effectivegatecpm.com/rdpsc1ap?key=04cfcd1d345b5b9493da19f4320c51ba";

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let currentUser = JSON.parse(localStorage.getItem('user_data')) || null;
        let isLoginMode = true;
        let luckyTimerInterval = null;
        let globalOrdersData = {}; 

        // --- INIT & RECOVERY ---
        window.onload = () => {
            fetchAdminSettings();
            setTimeout(() => {
                document.getElementById('splash-screen').classList.add('hidden');
                if (currentUser) {
                    initApp();
                    const lastTab = localStorage.getItem('last_tab') || 'home';
                    switchTab(lastTab);
                    if(!sessionStorage.getItem('welcome_seen')) document.getElementById('welcome-modal').classList.remove('hidden');
                    
                    // ðŸ”¥ RECOVER TASK ðŸ”¥
                    const pending = localStorage.getItem('pending_task');
                    if(pending) {
                        const task = JSON.parse(pending);
                        const elapsed = Date.now() - task.time;
                        if(elapsed < 12000) { 
                            showToast("Resuming Task... Wait â³");
                            setTimeout(() => finalizeTask(task.id, task.type), 10000 - elapsed);
                        } else {
                            finalizeTask(task.id, task.type); // Process immediately if time passed
                        }
                    }
                } else { document.getElementById('auth-screen').classList.remove('hidden'); }
            }, 2000);
        };

        function fetchAdminSettings() {
            onValue(ref(db, 'settings/official_link'), s => { if(s.exists()) fixedInstaLink = s.val(); });
            onValue(ref(db, 'settings/ad_links'), s => { if(s.exists()) { smartAdLinks = []; s.forEach(c => smartAdLinks.push(c.val())); }});
        }

        window.closeModal = () => { document.getElementById('welcome-modal').classList.add('hidden'); sessionStorage.setItem('welcome_seen', 'true'); };

        // --- AUTH ---
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('signup-fields').classList.toggle('hidden');
            document.getElementById('auth-title').innerText = isLoginMode ? "Login ðŸ‘‹" : "Create Account ðŸš€";
            document.getElementById('btn-auth').innerText = isLoginMode ? "Login" : "Create Account";
        };

        window.handleAuth = async () => {
            const insta = document.getElementById('inp-insta').value.trim();
            const pass = document.getElementById('inp-password').value.trim();
            if(!insta || !pass) { showToast("Enter details!"); return; }
            const uid = insta.toLowerCase().replace(/[^a-z0-9]/g, '');

            if(isLoginMode) {
                get(child(ref(db), `users/${uid}`)).then(s => {
                    if(s.exists() && s.val().password === pass) loginSuccess(s.val());
                    else showToast("Invalid Credentials âŒ");
                });
            } else {
                const name = document.getElementById('inp-name').value;
                const mobile = document.getElementById('inp-mobile').value;
                if(!name) { showToast("Fill details!"); return; }
                const userData = { uid, name, insta, mobile, password: pass, points: 0, coins: 0, lastBonus: 0, lastLuckyBonus: 0, officialTaskCompleted: false, completedOrders: {}, joinedAt: new Date().toISOString() };
                get(child(ref(db), `users/${uid}`)).then(s => {
                    if(s.exists()) showToast("User exists!");
                    else { set(ref(db, 'users/' + uid), userData); loginSuccess(userData); }
                });
            }
        };

        function loginSuccess(u) {
            localStorage.setItem('user_data', JSON.stringify(u));
            currentUser = u;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('welcome-modal').classList.remove('hidden'); 
            initApp(); switchTab('home');
        }

        window.logout = () => { localStorage.clear(); location.reload(); };

        function initApp() {
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('bottom-nav').classList.remove('hidden');
            document.getElementById('user-welcome').innerText = `Hello, ${currentUser.name}`;
            document.getElementById('referral-link').value = `https://myapp.com/ref/${currentUser.uid}`;
            
            listenToUserData();
            listenToOrdersData();
            checkBonusStatus();
        }

        function listenToUserData() {
            onValue(ref(db, 'users/' + currentUser.uid), (snapshot) => {
                if(snapshot.exists()) {
                    currentUser = snapshot.val();
                    document.getElementById('disp-points').innerText = currentUser.points;
                    document.getElementById('disp-coins').innerText = currentUser.coins;
                    localStorage.setItem('user_data', JSON.stringify(currentUser));
                    
                    checkBonusStatus();
                    const btnOfficial = document.getElementById('btn-official-task');
                    if(currentUser.officialTaskCompleted) { btnOfficial.innerText = "Completed âœ…"; btnOfficial.disabled = true; }
                    
                    renderLiveOrders();
                    renderMyOrders();
                }
            });
        }

        function listenToOrdersData() {
            onValue(ref(db, 'orders'), (snapshot) => {
                globalOrdersData = snapshot.val() || {};
                renderLiveOrders();
                renderMyOrders();
            });
        }

        // --- RENDER ORDERS ---
        function renderLiveOrders() {
            const container = document.getElementById('dynamic-tasks-container');
            // If processing, do not clear to prevent flickering
            if(localStorage.getItem('pending_task')) return;

            container.innerHTML = ""; 
            const doneTasks = currentUser.completedOrders || {};
            let ordersList = [];

            Object.keys(globalOrdersData).forEach(key => {
                const order = globalOrdersData[key];
                if(order.currentCount < order.targetCount && order.creatorUid !== currentUser.uid) {
                    ordersList.push({...order, key: key});
                }
            });

            ordersList.sort((a, b) => {
                const doneA = doneTasks[a.key] ? 1 : 0;
                const doneB = doneTasks[b.key] ? 1 : 0;
                return doneA - doneB;
            });

            if(ordersList.length === 0) { container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No live orders available.</p>'; return; }

            ordersList.forEach(order => {
                const isDone = doneTasks[order.key] === true;
                const isYt = order.platform === 'youtube';
                const cardClass = isYt ? 'card-youtube' : 'card-insta';
                const iconClass = isYt ? 'icon-youtube' : 'icon-insta';
                const iconHtml = isYt ? '<i class="fab fa-youtube"></i>' : '<i class="fab fa-instagram"></i>';
                const actionTitle = isYt ? 'Subscribe Channel' : 'Follow Profile';
                const statusText = isDone ? '<span style="color:green;">Completed âœ…</span>' : 'Live Order';
                
                let buttonHtml = isDone 
                    ? `<button id="btn-${order.key}" class="action-btn-small" disabled style="background:#eee; color:#999; border:1px solid #ddd;">Done <i class="fas fa-check"></i></button>`
                    : `<button id="btn-${order.key}" class="action-btn-small" onclick="startLiveTask('${order.key}', '${order.targetLink}', '${order.platform}')">Go <i class="fas fa-arrow-right"></i></button>`;

                container.innerHTML += `<div id="card-${order.key}" class="live-order-card ${cardClass}" style="${isDone?'opacity:0.6; order:999;':''}">
                    <div class="order-left"><div class="platform-icon ${iconClass}">${iconHtml}</div><div class="order-info"><h4>${actionTitle}</h4><small id="status-${order.key}"><i class="fas fa-circle" style="font-size:6px; color:${isDone?'green':'red'};"></i> ${statusText}</small></div></div>
                    <div class="order-right"><div class="points-badge">+25 Pts</div><div>${buttonHtml}</div></div></div>`;
            });
        }

        // --- ðŸ”¥ SAFE LINK & TASK LOGIC ðŸ”¥ ---
        function safeOpen(link) {
            const validUrl = link.startsWith('http') ? link : 'https://' + link;
            window.open(validUrl, '_blank');
        }

        window.startLiveTask = (id, link, plat) => {
            if(currentUser.completedOrders && currentUser.completedOrders[id]) return showToast("Already Done");
            
            // Save state
            localStorage.setItem('pending_task', JSON.stringify({ id, type: 'live', time: Date.now() }));
            
            safeOpen(link);
            showToast("Opening... Wait 10s â³");
            
            // Visual Update
            const btn = document.getElementById(`btn-${id}`);
            if(btn) { btn.innerText = "Check..."; btn.disabled = true; }

            setTimeout(() => finalizeTask(id, 'live'), 10000);
        };

        // --- FINALIZER (ANTI-CHEAT) ---
        async function finalizeTask(id, type) {
            // Check if already processed
            if(type === 'live' && currentUser.completedOrders && currentUser.completedOrders[id]) {
                localStorage.removeItem('pending_task');
                renderLiveOrders();
                return;
            }

            let pts = 0;
            let updates = {};

            if(type === 'live') {
                const taskRef = child(ref(db), `users/${currentUser.uid}/completedOrders/${id}`);
                const snap = await get(taskRef);
                if(snap.exists()) { localStorage.removeItem('pending_task'); return; }

                pts = 25;
                updates[`users/${currentUser.uid}/completedOrders/${id}`] = true;
                
                // Server Sync
                get(child(ref(db), `orders/${id}`)).then(s => {
                    if(s.exists()) {
                        let d = s.val(); let n = (d.currentCount || 0) + 1;
                        if(n >= d.targetCount) remove(ref(db, `orders/${id}`));
                        else update(ref(db, `orders/${id}`), {currentCount: n});
                    }
                });
            } 
            else if(type === 'ad') pts = 25;
            else if(type === 'official') { pts = 25; updates[`users/${currentUser.uid}/officialTaskCompleted`] = true; }
            else if(type === 'lucky') {
                pts = [5,10,20,50][Math.floor(Math.random()*4)];
                updates[`users/${currentUser.uid}/lastLuckyBonus`] = Date.now();
            }

            if(pts > 0) {
                updates[`users/${currentUser.uid}/points`] = (currentUser.points || 0) + pts;
                await update(ref(db), updates);
                showToast(`Success! +${pts} Points âœ…`);
            }

            localStorage.removeItem('pending_task');
            
            // Force Local Update & Render
            if(type === 'live') {
                if(!currentUser.completedOrders) currentUser.completedOrders = {};
                currentUser.completedOrders[id] = true;
                localStorage.setItem('user_data', JSON.stringify(currentUser));
                renderLiveOrders();
            }
        }

        // --- OTHER TASKS ---
        window.doAdTask = () => {
            const link = smartAdLinks[Math.floor(Math.random()*smartAdLinks.length)];
            localStorage.setItem('pending_task', JSON.stringify({ id: 'ad', type: 'ad', time: Date.now() }));
            safeOpen(link); showToast("Wait 10s...");
            setTimeout(() => finalizeTask('ad', 'ad'), 10000);
        };

        window.doStaticInstaTask = () => {
            if(currentUser.officialTaskCompleted) return;
            localStorage.setItem('pending_task', JSON.stringify({ id: 'off', type: 'official', time: Date.now() }));
            safeOpen(fixedInstaLink); showToast("Wait 10s...");
            setTimeout(() => finalizeTask('off', 'official'), 10000);
        };

        // --- LUCKY BONUS (30 MIN TIMER) ---
        const LUCKY_COOLDOWN = 30 * 60 * 1000; // 30 Minutes
        window.claimLuckyBonus = () => {
            const now = Date.now();
            if (now - (currentUser.lastLuckyBonus||0) < LUCKY_COOLDOWN) return showToast("Wait Cooldown!");
            
            localStorage.setItem('pending_task', JSON.stringify({ id: 'lucky', type: 'lucky', time: Date.now() }));
            safeOpen(luckySmartLink); 
            showToast("Spinning... Wait 10s");
            setTimeout(() => finalizeTask('lucky', 'lucky'), 10000);
        };

        function checkBonusStatus() {
            const now = Date.now();
            const btnD = document.getElementById('btn-daily-bonus');
            if(now - currentUser.lastBonus < 86400000) { btnD.innerText="Claimed"; btnD.disabled=true; } else { btnD.innerText="Claim"; btnD.disabled=false; }
            
            const btnL = document.getElementById('btn-lucky-bonus');
            const txtL = document.getElementById('lucky-timer');
            if(now - (currentUser.lastLuckyBonus||0) < LUCKY_COOLDOWN) {
                btnL.innerText = "Wait"; btnL.disabled = true;
                if(luckyTimerInterval) clearInterval(luckyTimerInterval);
                luckyTimerInterval = setInterval(() => {
                    const left = LUCKY_COOLDOWN - (Date.now() - currentUser.lastLuckyBonus);
                    if(left <= 0) { clearInterval(luckyTimerInterval); checkBonusStatus(); }
                    else {
                        const m = Math.floor((left % (1000*60*60)) / (1000*60));
                        const s = Math.floor((left % (1000*60)) / 1000);
                        txtL.innerText = `${m}m ${s}s left`;
                    }
                }, 1000);
            } else { btnL.innerText = "Spin"; btnL.disabled = false; txtL.innerText = "Ready!"; }
        }

        window.claimDailyBonus = () => {
            const now = Date.now();
            if (now - currentUser.lastBonus < 86400000) return showToast("Wait 24h");
            update(ref(db, `users/${currentUser.uid}`), { coins: (currentUser.coins||0)+2, lastBonus: Date.now() });
            showToast("Claimed +2 Coins");
        };

        window.convertPoints = () => {
            if(currentUser.points < 10) return showToast("Need 10 Pts");
            const add = Math.floor(currentUser.points/10);
            update(ref(db, `users/${currentUser.uid}`), { points: currentUser.points-(add*10), coins: currentUser.coins+add });
            showToast(`Converted +${add} Coins`);
        };

        window.updateOrderPlaceholder = () => {
            const p = document.getElementById('order-platform').value;
            document.getElementById('order-link').placeholder = p === 'youtube' ? "YouTube Link" : "Insta Link";
        };

        window.placeOrder = () => {
            const p = document.getElementById('order-platform').value;
            const s = document.getElementById('order-select').value.split('|');
            const l = document.getElementById('order-link').value;
            const cost = parseInt(s[0]);
            const target = parseInt(s[1]);
            
            if(currentUser.coins < cost) return showToast(`Need ${cost} Coins!`);
            if(!l) return showToast("Enter Link");
            
            update(ref(db, `users/${currentUser.uid}`), { coins: currentUser.coins - cost });
            push(child(ref(db), 'orders'), { creatorUid: currentUser.uid, targetLink: l, platform: p, targetCount: target, currentCount: 0, cost: cost, timestamp: new Date().toISOString() });
            showToast("Order Live!"); switchTab('home');
        };

        window.switchTab = (t) => { ['home','order','invite'].forEach(x => document.getElementById(`tab-${x}`).classList.add('hidden')); document.getElementById(`tab-${t}`).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); if(t==='home') document.querySelectorAll('.nav-item')[0].classList.add('active'); if(t==='order') document.querySelectorAll('.nav-item')[1].classList.add('active'); if(t==='invite') document.querySelectorAll('.nav-item')[2].classList.add('active'); localStorage.setItem('last_tab', t); };
        
        function renderMyOrders() {
            const container = document.getElementById('my-orders-container'); container.innerHTML = ""; let hasOrders = false;
            Object.values(globalOrdersData).forEach(order => {
                if (order.creatorUid === currentUser.uid) {
                    hasOrders = true; const pct = Math.min((order.currentCount / order.targetCount) * 100, 100); const icon = order.platform === 'youtube' ? '<i class="fab fa-youtube" style="color:red;"></i>' : '<i class="fab fa-instagram" style="color:#833AB4;"></i>';
                    container.innerHTML += `<div class="card"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><strong>${icon} ${order.platform.toUpperCase()}</strong><span class="badge" style="background:${pct>=100?'#27ae60':'#3498db'}; color:white;">${pct>=100?'Completed':'Processing'}</span></div><div class="progress-track"><div class="progress-fill" style="width:${pct}%;"></div></div><div class="order-status"><span>${order.currentCount}/${order.targetCount}</span><span>${order.cost} Coins</span></div></div>`;
                }
            });
            if (!hasOrders) container.innerHTML = "<p style='text-align:center; color:#999;'>No history.</p>";
        }

        window.copyInvite = () => { navigator.clipboard.writeText(document.getElementById('referral-link').value); showToast("Copied!"); };
        window.showToast = (msg) => { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(()=>x.classList.remove("show"), 3000); };
    </script>
</body>
</html>
